package cn.dustlight.auth.resources.core;

import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.MediaType;
import org.springframework.web.reactive.function.BodyInserters;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

import java.nio.charset.StandardCharsets;
import java.util.Base64;

public abstract class AbstractOpaqueAuthTokenService<T> implements TokenService {

    private WebClient client;

    private String clientId, clientSecret, uri, base64Header;

    public AbstractOpaqueAuthTokenService(String clientId, String clientSecret, String uri) {
        client = WebClient.create();
        this.clientId = clientId;
        this.clientSecret = clientSecret;
        this.uri = uri;
        refreshBase64Header();
    }

    @Override
    public Mono<AuthPrincipal> check(String token) {
        return client.method(HttpMethod.POST)
                .uri(uri)
                .header("Authorization", "Basic " + base64Header)
                .header(HttpHeaders.ACCEPT, MediaType.APPLICATION_JSON_VALUE)
                .body(BodyInserters.fromFormData("token", token))
                .retrieve()
                .bodyToMono(bodyClass())
                .map(body -> map(body, token))
                .onErrorMap(throwable -> new CheckTokenException("Check token failed: " + throwable.getMessage(), throwable));
    }

    protected abstract Class<T> bodyClass();

    protected abstract AuthPrincipal map(T body, String token);

    private void refreshBase64Header() {
        base64Header = Base64.getEncoder().encodeToString((clientId + ":" + clientSecret).getBytes(StandardCharsets.UTF_8));
    }

    public String getClientId() {
        return clientId;
    }

    public void setClientId(String clientId) {
        this.clientId = clientId;
        refreshBase64Header();
    }

    public String getClientSecret() {
        return clientSecret;
    }

    public void setClientSecret(String clientSecret) {
        this.clientSecret = clientSecret;
        refreshBase64Header();
    }

    public String getUri() {
        return uri;
    }

    public void setUri(String uri) {
        this.uri = uri;
    }
}
